<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Schedule Task Viewer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --background-primary: #F3F4F6;
            --background-secondary: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --border-primary: #E5E7EB;
            --border-secondary: #D1D5DB;
            --accent-primary: #4F46E5;
            --accent-primary-hover: #4338CA;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --border-radius-md: 0.5rem; /* 8px */
            --border-radius-lg: 0.75rem; /* 12px */

            /* Department/Task Colors - Harmonized Palette */
            --color-mill: #06B6D4; --color-mill-text: #FFFFFF;       /* Cyan */
            --color-form-out: #3B82F6; --color-form-out-text: #FFFFFF; /* Blue */
            --color-cast: #EF4444; --color-cast-text: #FFFFFF;       /* Red */
            --color-demold: #F97316; --color-demold-text: #FFFFFF;    /* Orange */
            --color-finish: #8B5CF6; --color-finish-text: #FFFFFF;    /* Violet */
            --color-seal: #EAB308; --color-seal-text: #1F2937;       /* Yellow */
            --color-special: #EC4899; --color-special-text: #FFFFFF;   /* Pink */
            --color-crating: #6366F1; --color-crating-text: #FFFFFF;  /* Indigo */
            --color-load: #F59E0B; --color-load-text: #FFFFFF;       /* Amber */
            --color-ship: #22C55E; --color-ship-text: #FFFFFF;       /* Green */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100vh;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-primary);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100%;
            overflow: hidden;
        }

        .container {
            width: 100%;
            padding: 2rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        header p {
            font-size: 1.125rem;
            color: var(--text-secondary);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

       .action-group {
           display: flex;
           align-items: center;
           gap: 0.75rem;
       }

       .icon-btn {
           padding: 0.625rem; /* Square padding */
           display: flex;
           align-items: center;
           justify-content: center;
           width: 40px; /* Explicit width */
           height: 40px; /* Explicit height */
       }

       .icon-btn svg {
           width: 2rem;
           height: 2rem;
       }

        .navigation-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-content: center;
            flex-grow: 1;
        }

        #week-display {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        label {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        select, button {
            padding: 0.625rem 1rem;
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius-md);
            font-size: 0.875rem;
            background-color: var(--background-secondary);
            transition: all 0.2s ease-in-out;
            font-family: 'Inter', sans-serif;
        }
        
        select:focus, button:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px var(--accent-primary);
        }

        button {
            background-color: var(--accent-primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        button:hover {
            background-color: var(--accent-primary-hover);
        }

        .schedule-wrapper {
            overflow-x: scroll;
            scroll-snap-type: x proximity;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            scrollbar-width: none; /* Hide scrollbar for Firefox */
            flex-grow: 1;
            overflow-y: auto;
            /* Performance optimization: Reduce paint and layout operations */
            contain: layout style paint;
            will-change: scroll-position;
        }

        .schedule-wrapper::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome, Safari, and Opera */
        }

        .schedule-container {
            display: flex;
            width: max-content; /* Allow container to grow with all the weeks */
            align-items: flex-start; /* Align grids to the top */
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: minmax(140px, 1fr) repeat(6, minmax(180px, 2fr));
            width: 100%; /* Let the parent define the width */
            scroll-snap-align: start;
            background-color: var(--background-secondary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            /* overflow: hidden; */ /* This was preventing sticky positioning */
            border: 1px solid var(--border-primary);
        }

        .grid-header {
            font-weight: 600;
            font-size: 0.75rem;
            padding: 1rem 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            border-bottom: 2px solid var(--border-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            line-height: 1.2;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 4.5rem; /* Ensure consistent header height */
            position: sticky;
            top: 0;
            background-color: var(--background-secondary);
            z-index: 10;
        }

        .grid-header:first-child {
            left: 0;
            z-index: 15;
        }
 
        .date-weekday {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .date-day {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .grid-cell {
            padding: 0.75rem;
            border-bottom: 2px solid var(--border-primary);
            border-right: 2px solid var(--border-primary);
        }
        
        .grid-cell:last-child {
            border-right: none;
        }

        .department-label {
            font-weight: 600;
            font-size: 1rem;
            padding: 1rem;
            color: var(--text-primary);
            text-align: center;
            border-right: 2px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            color: #fff; /* Set a default high-contrast text color */
            position: sticky;
            left: 0;
            z-index: 5;
        }

        /* Department accent colors for labels */
        .department-label.department-mill { background-color: var(--color-mill); color: var(--color-mill-text); }
        .department-label.department-form-out { background-color: var(--color-form-out); color: var(--color-form-out-text); }
        .department-label.department-cast { background-color: var(--color-cast); color: var(--color-cast-text); }
        .department-label.department-demold { background-color: var(--color-demold); color: var(--color-demold-text); }
        .department-label.department-finish { background-color: var(--color-finish); color: var(--color-finish-text); }
        .department-label.department-seal { background-color: var(--color-seal); color: var(--color-seal-text); }
        .department-label.department-special { background-color: var(--color-special); color: var(--color-special-text); }
        .department-label.department-crating { background-color: var(--color-crating); color: var(--color-crating-text); }
        .department-label.department-load { background-color: var(--color-load); color: var(--color-load-text); }
        .department-label.department-ship { background-color: var(--color-ship); color: var(--color-ship-text); }

        .task-card {
            color: var(--text-primary);
            border-radius: var(--border-radius-md);
            padding: 0.75rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: none;
            display: flex;
            flex-direction: column;
            min-height: 140px;
            background-color: var(--background-secondary); /* Default background */
        }
        
        /* Department colors for task cards */
        .task-card.department-mill { background-color: var(--color-mill); color: var(--color-mill-text); }
        .task-card.department-form-out { background-color: var(--color-form-out); color: var(--color-form-out-text); }
        .task-card.department-cast { background-color: var(--color-cast); color: var(--color-cast-text); }
        .task-card.department-demold { background-color: var(--color-demold); color: var(--color-demold-text); }
        .task-card.department-finish { background-color: var(--color-finish); color: var(--color-finish-text); }
        .task-card.department-seal { background-color: var(--color-seal); color: var(--color-seal-text); }
        .task-card.department-special { background-color: var(--color-special); color: var(--color-special-text); }
        .task-card.department-crating { background-color: var(--color-crating); color: var(--color-crating-text); }
        .task-card.department-load { background-color: var(--color-load); color: var(--color-load-text); }
        .task-card.department-ship { background-color: var(--color-ship); color: var(--color-ship-text); }

        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .task-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: inherit; /* Inherit from parent card */
            text-align: center;
        }

        .task-description {
            font-size: 0.8rem;
            margin-bottom: 1rem;
            color: inherit;
            opacity: 0.8;
            flex-grow: 1;
            text-align: center;
        }

        .missing-description {
            color: #ef4444;
            font-weight: 600;
            opacity: 1;
            background-color: #fee2e2;
            border-radius: 4px;
            padding: 2px 4px;
        }

        .task-details {
            font-size: 0.8rem;
            color: inherit;
            opacity: 0.9;
            border-top: 1px solid rgba(0,0,0,0.08);
            padding-top: 0.5rem;
            margin-top: auto;
        }
        
        .task-details strong {
            color: inherit;
            font-weight: 600;
        }

        .task-day-counter {
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            padding: 0.25rem 0;
            margin: 0.5rem -0.75rem 0.5rem -0.75rem; /* Negative margin to span the padding of the parent */
            background-color: rgba(0,0,0,0.08);
            color: inherit; /* Inherit from parent card */
        }

        .task-card-placeholder {
            min-height: 140px;
            background: transparent;
            border: none;
        }

        .loading {
            text-align: center;
            padding: 4rem;
            font-size: 1.25rem;
            color: var(--text-secondary);
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            margin: 0 auto;
            border: 2px solid var(--border-primary);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s ease-in-out infinite;
            left: 50%;
            transform: translateX(-50%);
        }

        @keyframes spin {
            to { transform: translateX(-50%) rotate(360deg); }
        }

        .rendering-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--background-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius-md);
            padding: 0.5rem 1rem;
            box-shadow: var(--shadow-md);
            z-index: 1000;
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: none;
        }

        .error {
            background: #FEE2E2;
            color: #B91C1C;
            padding: 1rem;
            border-radius: var(--border-radius-md);
            margin-bottom: 1.5rem;
            border: 1px solid #FCA5A5;
        }

        /* --- Custom Multi-Select Dropdown --- */
        .multi-select-dropdown {
            position: relative;
            display: inline-block;
            min-width: 220px;
        }

        .multi-select-btn {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.625rem 1rem;
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius-md);
            background-color: var(--background-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            text-align: left;
            color: var(--text-primary);
            font-weight: 500;
        }

        .multi-select-btn:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px var(--accent-primary);
        }

        .multi-select-btn .dropdown-arrow {
            width: 1rem;
            height: 1rem;
            transition: transform 0.2s ease-in-out;
        }

        .multi-select-dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .multi-select-panel {
            display: none;
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            width: 100%;
            background-color: var(--background-secondary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-primary);
            z-index: 100;
            overflow: hidden;
        }

        .multi-select-dropdown.open .multi-select-panel {
            display: block;
        }

        .multi-select-actions {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .multi-select-actions button {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .multi-select-actions button:first-child {
            margin-right: 0.5rem;
            background-color: var(--accent-primary);
            color: white;
        }
        .multi-select-actions button:first-child:hover {
            background-color: var(--accent-primary-hover);
        }

        .multi-select-actions button:last-child {
            background-color: var(--border-primary);
            color: var(--text-primary);
        }
        .multi-select-actions button:last-child:hover {
            background-color: var(--border-secondary);
        }

        #department-list {
            list-style: none;
            padding: 0.5rem 0;
            /* max-height: 250px; */ /* Removed to show all */
            /* overflow-y: auto; */   /* Removed to show all */
        }

        #department-list li {
            padding: 0.6rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 0.875rem;
        }

        #department-list li:hover {
            background-color: var(--background-primary);
        }

        #department-list input[type="checkbox"] {
            margin-right: 0.75rem;
            width: 1rem;
            height: 1rem;
            accent-color: var(--accent-primary);
        }
        /* --- End Custom Multi-Select Dropdown --- */

        .date-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            box-sizing: border-box;
            width: 100%;
            height: 100%;
        }

        .today-highlight {
            background-color: #fde68a;
            color: #92400e;
            border-radius: 8px;
        }

        .today-highlight .date-weekday,
        .today-highlight .date-day {
            color: inherit;
        }

        @media (max-width: 1200px) {
            .schedule-grid {
                grid-template-columns: minmax(120px, 1fr) repeat(7, minmax(150px, 1fr));
            }
        }

        /* --- Context Menu Styles --- */
        .context-menu {
            position: fixed;
            background: var(--background-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            z-index: 10000;
            min-width: 180px;
            display: none;
            overflow: hidden;
            backdrop-filter: blur(10px);
            animation: fadeInScale 0.15s ease-out;
        }

        .context-menu-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .context-menu-item:hover {
            background-color: var(--accent-primary);
            color: white;
        }

        .context-menu-item::before {
            content: '';
            width: 16px;
            height: 16px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.7;
        }

        .context-menu-item.build-plan::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='3' width='18' height='18' rx='2' ry='2'/%3E%3Cline x1='9' y1='9' x2='15' y2='15'/%3E%3Cline x1='15' y1='9' x2='9' y2='15'/%3E%3C/svg%3E");
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.85) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes slideInBounce {
            0% {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            60% {
                opacity: 0.8;
                transform: translateY(5px) scale(1.02);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes elegantFadeIn {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            50% {
                opacity: 0.7;
                transform: translateY(-5px) scale(1.01);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: var(--shadow-sm);
            }
            50% {
                box-shadow: 0 0 20px rgba(79, 70, 229, 0.3), var(--shadow-md);
            }
        }

        /* --- Project View Modal --- */
        .project-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(0px);
            z-index: 9999;
            display: none;
            animation: modalBackdropFade 0.4s ease-out;
            padding: 2rem;
            box-sizing: border-box;
        }

        .project-modal.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .project-content {
            background: var(--background-secondary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            width: 95vw;
            max-width: 1400px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideInBounce 0.5s ease-out;
            border: 1px solid var(--border-primary);
            transition: all 0.3s ease;
            position: relative; /* For loading overlay positioning */
        }

        .edit-description {
            width: 100%;
            min-height: 60px;
            padding: 0.5rem;
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius-md);
            font-size: 0.8rem;
            font-family: 'Inter', sans-serif;
            resize: vertical;
            background-color: var(--background-secondary);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }

        .edit-description:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }

        .project-content:hover {
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15), var(--shadow-md);
            transform: translateY(-2px);
        }

        .project-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--background-primary);
            position: relative;
        }

        .project-header .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        #unlock-editing-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--shadow-sm);
        }

        #unlock-editing-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        #edit-plan-btn, #save-changes-btn, #cancel-changes-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--shadow-sm);
        }

        #edit-plan-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        #edit-plan-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        #save-changes-btn {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
        }

        #save-changes-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        #cancel-changes-btn {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            color: white;
        }

        #cancel-changes-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Save button loading spinner */
        .save-loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: button-spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        @keyframes button-spin {
            to { transform: rotate(360deg); }
        }

        .project-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .project-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
            border-radius: var(--border-radius-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .project-close::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, var(--accent-primary) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .project-close:hover {
            color: var(--accent-primary);
            transform: scale(1.1) rotate(90deg);
        }

        .project-close:hover::before {
            opacity: 0.2;
        }

        .project-close:active {
            transform: scale(0.95) rotate(90deg);
        }

        .project-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .project-schedule-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background-color: var(--background-secondary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-primary);
            padding: 1rem;
        }

        .project-dept-section {
            display: flex;
            align-items: stretch;
            gap: 0;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius-md);
            overflow: hidden;
        }

        .project-dept-header {
            font-weight: 600;
            font-size: 1rem;
            padding: 1rem;
            color: var(--text-primary);
            text-align: center;
            border-right: 2px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            color: #fff;
            position: sticky;
            left: 0;
            z-index: 5;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-sm);
        }

        .project-cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.75rem;
            flex: 1;
            min-height: 200px;
            align-items: flex-start;
        }

        .project-task-card {
            background: var(--background-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius-md);
            padding: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            opacity: 0;
            transform: translateY(30px) scale(0.95);
            animation: elegantFadeIn 0.6s ease-out forwards;
            min-width: 250px;
            max-width: 300px;
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .project-task-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .project-task-card:nth-child(1) { animation-delay: 0.1s; }
        .project-task-card:nth-child(2) { animation-delay: 0.2s; }
        .project-task-card:nth-child(3) { animation-delay: 0.3s; }
        .project-task-card:nth-child(4) { animation-delay: 0.4s; }
        .project-task-card:nth-child(5) { animation-delay: 0.5s; }
        .project-task-card:nth-child(6) { animation-delay: 0.6s; }
        .project-task-card:nth-child(7) { animation-delay: 0.7s; }
        .project-task-card:nth-child(8) { animation-delay: 0.8s; }

        .project-task-card .task-title {
            font-size: 0.85rem;
        }

        .project-task-card .task-description {
            font-size: 0.75rem;
        }

        .project-task-card .task-details {
            font-size: 0.75rem;
        }

        @keyframes modalBackdropFade {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(5px);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* --- Project Modal Loading Overlay --- */
        .project-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(2px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: var(--border-radius-lg);
        }

        .project-loading-overlay .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: rotateSpinner 1s ease-in-out infinite;
            margin-bottom: 0.75rem;
        }

        .project-loading-overlay p {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin: 0;
            text-align: center;
        }

        @keyframes rotateSpinner {
            to { transform: rotate(360deg); }
        }

        /* --- Success Notification --- */
        .project-success-notification {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
            font-size: 0.875rem;
            font-weight: 600;
            z-index: 1010;
            display: none;
            animation: fadeInSlideDown 0.3s ease-out;
        }

        @keyframes fadeInSlideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            h1 {
                font-size: 2rem;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .schedule-grid {
                display: block;
            }
            .grid-header, .department-label {
                display: none;
            }
            .grid-cell {
                border: none;
                padding: 0 0 1rem 0;
            }
            .project-content {
                width: 95%;
                margin: 1rem auto;
            }
            .project-cards-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .project-header {
                padding: 1rem;
            }
            .project-body {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <div class="filter-group">
                <label>Filter by Department:</label>
                <div id="multi-select-dropdown" class="multi-select-dropdown">
                    <button id="multi-select-btn" class="multi-select-btn" aria-haspopup="listbox" aria-expanded="false">
                        <span id="multi-select-label">All Departments</span>
                        <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div id="multi-select-panel" class="multi-select-panel" role="listbox">
                        <div class="multi-select-actions">
                            <button id="select-all-btn">Show All</button>
                            <button id="select-none-btn">Show None</button>
                        </div>
                        <ul id="department-list">
                            <!-- Department checkboxes will be populated by JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>
            <div class="navigation-group">
                <button id="prev-week-btn">&larr; Previous</button>
                <h2 id="week-display"></h2>
                <button id="next-week-btn">Next &rarr;</button>
            </div>
            <div class="action-group">
               <button id="refresh-btn">Refresh Data</button>
               <button id="fullscreen-btn" class="icon-btn" aria-label="Toggle Fullscreen">
                   <svg id="fullscreen-icon-expand" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                       <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                   </svg>
                   <svg id="fullscreen-icon-compress" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                       <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 0 2-2h3M3 16h3a2 2 0 0 0 2-2v-3"/>
                   </svg>
               </button>
           </div>
        </div>

        <div id="loading" class="loading">Loading tasks...</div>
        <div id="rendering-status" class="rendering-status">Optimizing layout...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div class="schedule-wrapper" id="schedule-wrapper">
            <div class="schedule-container" id="schedule-container">
                <!-- Schedule weeks will be populated by JavaScript -->
            </div>
        </div>

        <!-- Context Menu -->
        <div class="context-menu" id="context-menu">
            <div class="context-menu-item build-plan" data-action="build-plan">
                📋 Build Plan
            </div>
        </div>

        <!-- Project View Modal -->
        <div class="project-modal" id="project-modal">
            <div class="project-content">
                <div class="project-header">
                    <h2 class="project-title" id="project-title">Build Plan</h2>
                    <div class="header-actions">
                        <button id="unlock-editing-btn">🔒 Unlock Editing</button>
                        <button id="edit-plan-btn" style="display: none;">✏️ Edit Plan</button>
                        <button id="save-changes-btn" style="display: none;">💾 Save Changes</button>
                        <button id="cancel-changes-btn" style="display: none;">❌ Cancel Changes</button>
                        <button class="project-close" id="project-close">&times;</button>
                    </div>
                </div>

                <!-- Success Notification -->
                <div id="project-success-notification" class="project-success-notification">
                    ✅ Changes saved successfully!
                </div>
                <div class="project-body">
                    <div class="project-schedule-grid" id="project-schedule-grid">
                        <!-- Project schedule will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Loading Overlay -->
                <div id="project-loading-overlay" class="project-loading-overlay" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Confirming edits...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // JavaScript will be added here
        const API_KEY = 'AIzaSyA0i2Mr7kVirmM72ggu_L7_3XAB3_EAsNw';
        const SPREADSHEET_ID = '1ReBnudzH_QAY6e45wwpf_sHd2OF1Akkppm0S7NmZ_ws';
        const SHEET_NAME = 'Primary Live List 2';
        const STAGING_SHEET_NAME = 'Staging - Project Details';

        // Service Account JSON
        let SERVICE_ACCOUNT = {
            "type": "service_account",
            "project_id": "test-1-468219",
            "private_key_id": "fbc2ff13cf04d5fb4b147818628d600e91ed5345",
            "private_key": "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRRGgrL2V2S3R0SVFDMmkKYld4\n4bFhHcFc3NlFqUno5aVpmdkdzSlZBbGJ0L3daalZRRWhvemh2cE0yZ3VVMGN6VnNndkI0cjZNWm8vQUFpZgpremloVFl6MWlOV0QrZ2l5cS83ekNvSVpmV1ZlK2tNUHdl\nldE1QU1lTVR1bmVLME0zS0xGNEp0c0gYVRLaTFlckYKOEwwcU5ueGhOUWtwa0cwM0U5c3J3bzZhOUY5eSt0K3dEVGNsTldRVnR6bGZJTGh4VituQ3RNeng5aTJIaFgvaTMK\nKL0E4Tmhtem5DW5kVUFscEFWSUwyNXlXeC8xakQvVFNTazV6OTUyZUo2Mmt6a256amNvR2ptakdmZ1Y3VDJ1awpFb2NHa29GUFF3SEowUy85NFhVa2pKeXFxRWQ2NUNu\nudlFINTdHZDM1akUwdGlHeVFSUkIxVzkvTXpHMU00QnJsCmRWeFY0ZStGQWdNQkFBRUNnZ0VBQjFaM0pHanYxZGkvb3BhSy9uK1J0R0R6bzNHY3pVVWlkOEVrRjRURklk\nkRFgKZFpVd3hMWnNrWlhwdkJkWUtJS1lM3dSSVM1M0k3U01reUhrcE5ndnk0azE1YU1veFNSd2t0TzBoYjljbTBqbApCSTMzWmZKV1dpSFYxakQxaVV6NDlnT2NkY20w\nwcTBXRzhsYm54YTZFYkwyOHlxTllVeHp3V2YvMldnMThUWFQ3CncvaEYzTVVWWUlpeWNHSWk0VFRjVDgya2RtcVYrTzAyL2diTktTS1VBWEYxTTFCRXNEVEVYWFFUZDJI\nISm5nNnMKY2xaWUROTVFMV1UyZ25ZcW5MVy8rU29MdmR2OHcxaEpKbFdjbUJoVjlvUGVSQ3h4QjhzVXd0M3h2djROak9Qcwp2ZnlncFNYa1JkQUhCd1dXdDBxS2J6bDFz\nzUFd6bUN4cS9GN0RWeGpyd1FLQmdRRDRuRzd4cno1NUdIZUVCM2F4CncvbXdldTdBMzRQUldPMUUzM1lDSFhFOXMvM3VLZlZMa2M0QmV6WE91WGxlV3htdGtlT1E0Y2lw\nwbHRwN0F5MkkKOEY5NDRwSTFqTWRXU3ErbTRzS1FibHRnZVQ1eEJ4bVM5SW84bXM5YUhDT29sb2UzVHlOUXRURllhZDQrNndpdwpBY0JWR0tmY0JDY1YweTUwZVR1aitm\nmL3FHd0tCZ1FEb3MyQ0w4WHFIenRXQjBYdGF4QjNyNSsxYWFEL1JqZGJOCmNObGxmS0FkWkc3NGFXeWNHRGNKNExFNnBSL1h5Q0hJVXg1djBhUHFLank3T0g1VDJCVmJw\nwczJzMUN5K3F6Um0KbXZjUjBWM2JybGJCMXBvZGZVd1dJMllXcDVDVjRGV0R1QUpsWVFnY05wOEpqK1lHRXkzb1lnSlhPTmJXeE1LWAo1RkRhVE84bTN3S0JnRTBIbTFD\nDRExlWXpjSVNXRTI3TS9BWjBjSm1PSjcgZXJ5QWg0L0lWM1Bla1NaZkZ2U3JPWgpmNnp4MGlBMVU2ZXFybkFiTGRsc085SmdEVjNrQkMzVDNLRUdBcXRZN1VLTmJaTlYy\nyMWNJK29NUHpnc1RXaGN3CmNjeUpZd25XZ2kzd1JiakQrbnM5U1FiTjlyQ2ovbE1hbDg5R0RteWJWTWpzWUE1eXFjb0s0Z0pWQW9HQkFObWsKYS9oM3NwS3k4UjZxUHlW\nWMXFFYXNkV0xKZm1jUXNvY1R0VUVtZnRyK3hJdXlqdEt3RTBvNXpZbDhSM3dhd3Y0SwpQNzExNWtsdGw3L0Q1dU9raHRWaC9aeFlGa0YrLzFPNFBMMTloTHVqSTZISWhm\nmeHU1R3NRVUx0L25jdVFObXNyCi81R3lYMU9FQXR0K3F6V2pXcHl1am1IbDE0cW9IUmpUZ291cXlVTWhBb0dBVmhUU1J6Y081RnE1OHNINVJDTEoKckR2UFhCdEtBL0l3\n3a1N3eHUwdHdzQkZhb0hER0YydWQvL3BFVDdvNkI3V1NEQkdJSzcySEtYSXo2eU1TdzBVZwo1QkF5UTYzdjE3UHVjRVpmWUw5eVVET25hLy9jb3FDdlZUd2dXcDJBWDd3\n3MHNublV0d1NWMUtHTVY5bG9kc3JzCk1wVThZRWNpT2s2SU1qYVVUbVNJVE5rPQotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tCg==",
            "client_email": "sheet-writer@test-1-468219.iam.gserviceaccount.com",
            "client_id": "117725617866432687465",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/sheet-writer%40test-1-468219.iam.gserviceaccount.com",
            "universe_domain": "googleapis.com"
        };

        let cachedAccessToken = null;
        let tokenExpiry = null;

        let allTasks = [];
        let filteredTasks = [];
        let currentDate = new Date();
        let allWeekStartDates = []; // Store the start dates of all rendered weeks
        const EDIT_PASSWORD = 'cwe'; // Rudimentary password for unlocking editing
        let currentProjectName = '';

        const departmentDayMapping = {
            "Mill 1": 5,
            "Mill 2": 8,
            "Mill 3": 11,
            "Mill 4": 14,
            "Form Out 1": 17,
            "Form Out 2": 20,
            "Form Out 3": 23,
            "Form Out 4": 26,
            "Cast 1": 29,
            "Cast 2": 32,
            "Demold 1": 37,
            "Demold 2": 40,
            "Crating 1": 46,
            "Crating 2": 49,
            "Finish 1": 58,
            "Finish 2": 61,
            "Finish 3": 64,
            "Finish 4": 67,
            "Seal 1": 70,
            "Seal 2": 73,
            "Seal 3": 76,
            "Seal 4": 79,
            "Special 1": 82,
            "Special 2": 85,
            "Special 3": 88,
            "Ship 1": 94,
            "Ship 2": 97,
            "Load 1": 52
        };

        SERVICE_ACCOUNT.private_key = `-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDh+/evKttIQC2i\nbWxlXGpW76QjRz9iZfvGsJVAlbt/wZjVQEhozhvpM2guU0czVsgvB4r6MZo/AAif\nkzihTYz1iNWD+giyq/7zCoIZfWVe+kMPwetMPSYSTuneK8G3KLFxJss8aTKk1evF\n/0qoNxxNQKpkG03E9srwo6a9F9y+t+wDTclNWQVtzlfILhxW+nCtMzx9i2HhX/i3\n/A8NhmznCZwVALPAVIL25yWx/1jD/TSSk5z952eJ62kzknzjcoGjmjgFfgV7T2uk\nEocGkoFPQwHJ0S/94XUkjJyqqEd65CnvQH57Gd35jE0tiGyQRRB1W9/MzG1M4Brl\ndVxV4e+FAgMBAAECggEAB1Z3JGjv1di/opaK/n+RtGDzo3GczUUid8EkF4TFIdDX\ndZUwxLZskZXpvBdYKIKY3W4RRS53I7SMkyHkpNgvy4k15aMoxSRwktO0hb9cm0jl\nBI33ZfJWWiHV1jD1iUz49gOcdcm0q0WG8lbnxa6EbL28yqNYUxzwWf/2Wg18TXT7\nw/hF3MUVYIiycGIy4TTcT82kdmqV+O02/gbNKSKUAXF1M1BEsDTEXXQTd2HJng6s\nclZYDNMQLWU2gnYqnLW/+SoLvdv8w1hJJlWcmBhV9oPeRCxxB8sUwt3xvv4NjOPs\nvfygpSXkRdAHBwWWt0qKbzl1sPWzmCxq/F7DVxjrwQKBgQD4nG7xrz55GHeEB3ax\nw/mweu7A34PRWO1E33YCHXE9s/3uKfVLkc4BezXOuXleWxmtkeOQ4cipltp7Ay2I\n8F944pI1jMdWSq+m4sKQbltgeT5xBxmS9Io8ms9aHCOoloe3TyNQtTFYad4+6wiw\nAcBVGKfcBCcV0y50eTuj+f/qGwKBgQDos2CL8XqHztWB0XtaxB3r5+1aaD/RjdbN\ncNllfKAdZG74aWycGDcJ4LE6pR/XyCHIUx5v0aPqKjy7OH5T2BVbps2s1Cy+qzRm\nmvcR0V3brlbB1podfUwWI2YWp5CV4FWDuAJlYQgcNp8Jj+YGEy3oYgJXONbWxMKX\n5FDaTO8m3wKBgE0Hm1CDLeYzcISWE27M/AZ0cJmOJ7 eryAh4/IV3PekSZfFvSrOZ\nf6zx0iA1U6eqrnAbLdlsO9JgDV3kBC3T3KEGAqtY7UKNbZNV21cI+oMPzgsTWhcw\nccyJYwnWgi3wRijD+ns9SQbN9rCj/lMal89GDmybVMjsYA5yqcoK4gJVAoGBANmk\na/h3spKy8R6qPyV1qEasdWLJfmcQsocTtUEmftr+xIuyjtKwE0o5zYl8R3wawv4K\nP7115kltl7/D5uOkhtVh/ZxYFkF+/1O4PL19hLujI6HIhfxu5GsQULt/ncuQNmsr\n/5GyX1OEAtt+qzWjWpyujmHl14qoHRjTgouqyUMhAoGAVhTSRzcO5Fq58sH5RCLJ\nrDvPXBtKA/IwkSwxu0twsBFaoHDGF2ud//pET7o6B7WSDBGIK72HKXIz6yMSw0Ug\n5BAyQ63v17PucEZfYL9yUDOna//coqCvVTwgWp2AX7w0snnUtwSV1KGMV9lodsrs\nMpU8YEciOk6IMjaUTmSITNk=\n-----END PRIVATE KEY-----\n`;

        // JWT and OAuth functions for service account authentication
        function base64UrlEncode(str) {
            return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        function base64UrlDecode(str) {
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            while (str.length % 4) str += '=';
            return atob(str);
        }

        async function generateJWT() {
            const header = {
                alg: 'RS256',
                typ: 'JWT'
            };
            const now = Math.floor(Date.now() / 1000);
            const payload = {
                iss: SERVICE_ACCOUNT.client_email,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                aud: 'https://oauth2.googleapis.com/token',
                exp: now + 3600,
                iat: now
            };

            const encodedHeader = base64UrlEncode(JSON.stringify(header));
            const encodedPayload = base64UrlEncode(JSON.stringify(payload));
            const message = encodedHeader + '.' + encodedPayload;

            const privateKeyPem = SERVICE_ACCOUNT.private_key.replace(/-----BEGIN PRIVATE KEY-----\n/, '').replace(/\n-----END PRIVATE KEY-----\n/, '').replace(/\n/g, '');
            let privateKeyDer;
            try {
                privateKeyDer = Uint8Array.from(atob(privateKeyPem), c => c.charCodeAt(0));
            } catch (e) {
                console.log('Error with atob:', e.message);
                console.log('privateKeyPem:', privateKeyPem);
                throw e;
            }

            const privateKey = await crypto.subtle.importKey(
                'pkcs8',
                privateKeyDer,
                {
                    name: 'RSASSA-PKCS1-v1_5',
                    hash: 'SHA-256'
                },
                false,
                ['sign']
            );

            const signature = await crypto.subtle.sign('RSASSA-PKCS1-v1_5', privateKey, new TextEncoder().encode(message));
            const encodedSignature = base64UrlEncode(String.fromCharCode(...new Uint8Array(signature)));

            return message + '.' + encodedSignature;
        }

        async function getAccessToken() {
            if (cachedAccessToken && tokenExpiry && Date.now() < tokenExpiry) {
                return cachedAccessToken;
            }

            const jwt = await generateJWT();
            const response = await fetch('https://oauth2.googleapis.com/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
                    assertion: jwt
                })
            });

            if (!response.ok) {
                throw new Error('Failed to get access token');
            }

            const data = await response.json();
            cachedAccessToken = data.access_token;
            tokenExpiry = Date.now() + (data.expires_in * 1000) - 60000; // Refresh 1 minute before expiry
            return cachedAccessToken;
        }

        // Department order for sorting
        const DEPARTMENT_ORDER = [
            'Mill',
            'Form Out',
            'Cast',
            'Demold',
            'Finish',
            'Seal',
            'Special',
            'Crating',
            'Load',
            'Ship'
        ];

        function normalizeDepartment(dept) {
            if (!dept) return '';
            const normalized = dept.toLowerCase().trim();
            if (normalized === 'formout' || normalized === 'form out') return 'Form Out';
            if (normalized === 'crate' || normalized === 'crating') return 'Crating';
            return dept;
        }

        function normalizeDepartmentClass(dept) {
            if (!dept) return '';
            return dept.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const [month, day, year] = parts.map(Number);
                const date = new Date(year, month - 1, day);
                return isNaN(date) ? null : date;
            }
            // If already YYYY-MM-DD
            const parts2 = dateStr.split('-');
            if (parts2.length === 3) {
                const [year, month, day] = parts2.map(Number);
                const date = new Date(year, month - 1, day);
                return isNaN(date) ? null : date;
            }
            const date = new Date(dateStr); // fallback
            return isNaN(date) ? null : date;
        }

        function getLocalDateString(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function fetchTasks() {
            try {
                showLoading(true);
                hideError();

                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!A1:Z?key=${API_KEY}`);
                const data = await response.json();

                if (!data.values) {
                    throw new Error('No data found in sheet');
                }

                allTasks = parseSheetData(data.values);
                calculateProjectDayCounts(allTasks); // Calculate the day counts
                populateDepartmentCheckboxes();
                filterTasks(); // This will call renderWeeklySchedule
                showLoading(false);
            } catch (error) {
                showError('Failed to load tasks: ' + error.message);
                showLoading(false);
            }
        }

        async function getSheetId(sheetName) {
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?key=${API_KEY}`);
            if (!response.ok) throw new Error('Failed to fetch sheet metadata');
            const data = await response.json();
            const sheet = data.sheets.find(s => s.properties.title === sheetName);
            return sheet ? sheet.properties.sheetId : null;
        }

        async function getStagingData() {
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${STAGING_SHEET_NAME}!A1:Z?key=${API_KEY}`);
            if (!response.ok) throw new Error('Failed to fetch staging data');
            const data = await response.json();
            return data.values || [];
        }

        function stripHtml(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        async function saveToStaging(projectName, changedTasks) {
            try {
                const sheetId = await getSheetId(STAGING_SHEET_NAME);
                if (!sheetId) throw new Error('Staging sheet not found');
                const stagingData = await getStagingData();
                const headers = stagingData[0] || [];
                let projectCol = headers.indexOf(projectName);
                const requests = [];
                if (projectCol === -1) {
                    // Insert column after D (index 3, so startIndex 4)
                    requests.push({
                        "insertDimension": {
                            "range": {
                                "sheetId": sheetId,
                                "dimension": "COLUMNS",
                                "startIndex": 4,
                                "endIndex": 5
                            },
                            "inheritFromBefore": false
                        }
                    });
                    // Set header in new column E (index 4)
                    requests.push({
                        "updateCells": {
                            "range": {
                                "sheetId": sheetId,
                                "startRowIndex": 0,
                                "endRowIndex": 1,
                                "startColumnIndex": 4,
                                "endColumnIndex": 5
                            },
                            "rows": [{
                                "values": [{
                                    "userEnteredValue": { "stringValue": projectName }
                                }]
                            }],
                            "fields": "userEnteredValue"
                        }
                    });
                    projectCol = 4;
                }
                // Now update the changed descriptions
                changedTasks.forEach(({task, newText}) => {
                    const deptDay = task.department + ' ' + task.dayNumber;
                    const rowIndex = departmentDayMapping[deptDay];
                    if (rowIndex !== undefined) {
                        requests.push({
                            "updateCells": {
                                "range": {
                                    "sheetId": sheetId,
                                    "startRowIndex": rowIndex - 1,
                                    "endRowIndex": rowIndex,
                                    "startColumnIndex": projectCol,
                                    "endColumnIndex": projectCol + 1
                                },
                                "rows": [{
                                    "values": [{
                                        "userEnteredValue": { "stringValue": newText }
                                    }]
                                }],
                                "fields": "userEnteredValue"
                            }
                        });
                    }
                });
                if (requests.length > 0) {
                    const accessToken = await getAccessToken();
                    const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}:batchUpdate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({ requests })
                    });
                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error('Failed to update sheet: ' + error);
                    }
                    console.log('Successfully saved to staging sheet');
                }
            } catch (error) {
                console.error('Error saving to staging:', error);
                alert('Failed to save changes: ' + error.message);
            }
        }

        function parseSheetData(rows) {
            const tasks = [];
            const headers = rows[0];

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.length >= 1) {  // Import incomplete entries
                    const task = {
                            id: `task-${i}`,
                            week: row[0] || '',
                            project: row[1] || '',
                            description: row[9] || '',
                            date: row[3] || '',
                            department: normalizeDepartment(row[4] || ''),
                            value: row[5] || '',
                            hours: row[6] || '',
                            dayNumber: row[7] || '',
                            totalDays: row[8] || ''
                        };
                    tasks.push(task);
                }
            }

            return tasks;
        }

        function calculateProjectDayCounts(tasks) {
            tasks.forEach(task => {
                const taskDate = parseDate(task.date);
                if (!taskDate) {
                    task.missingDate = true;
                }
                if (task.dayNumber && task.totalDays) {
                    const dayNum = parseInt(task.dayNumber);
                    const total = parseInt(task.totalDays);
                    if (!isNaN(dayNum) && !isNaN(total)) {
                        task.dayCounter = `Day ${dayNum} of ${total}`;
                    } else {
                        task.dayCounter = '';
                    }
                } else {
                    task.dayCounter = '';
                }
            });
        }

        function getSelectedDepartments() {
            const selected = [];
            document.querySelectorAll('#department-list input[type="checkbox"]:checked').forEach(checkbox => {
                selected.push(checkbox.value);
            });
            return selected;
        }

        function populateDepartmentCheckboxes() {
            const uniqueDepartmentsInTasks = new Set(allTasks.map(task => task.department));
            const departments = DEPARTMENT_ORDER.filter(dept => uniqueDepartmentsInTasks.has(dept));
            const list = document.getElementById('department-list');
            list.innerHTML = ''; // Clear previous list

            const savedDepartments = JSON.parse(localStorage.getItem('selectedDepartments')) || departments;

            departments.forEach(dept => {
                const listItem = document.createElement('li');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `dept-${normalizeDepartmentClass(dept)}`;
                checkbox.value = dept;
                checkbox.checked = savedDepartments.includes(dept);

                const label = document.createElement('label');
                label.htmlFor = `dept-${normalizeDepartmentClass(dept)}`;
                label.textContent = dept;

                listItem.appendChild(checkbox);
                listItem.appendChild(label);
                list.appendChild(listItem);

                // Add event listener to filter tasks when a checkbox is changed
                listItem.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                    filterTasks();
                });
            });
            updateMultiSelectLabel();
        }

        function updateMultiSelectLabel() {
            const selectedCount = getSelectedDepartments().length;
            const totalCount = document.querySelectorAll('#department-list input[type="checkbox"]').length;
            const label = document.getElementById('multi-select-label');

            if (selectedCount === 0) {
                label.textContent = 'None Selected';
            } else if (selectedCount === totalCount) {
                label.textContent = 'All Departments';
            } else if (selectedCount === 1) {
                label.textContent = getSelectedDepartments()[0];
            } else {
                label.textContent = `${selectedCount} Departments Selected`;
            }
        }

        function filterTasks() {
            const selectedDepartments = getSelectedDepartments();
            localStorage.setItem('selectedDepartments', JSON.stringify(selectedDepartments));

            if (selectedDepartments.length === 0) {
                filteredTasks = [];
            } else {
                const allDeptsSelected = selectedDepartments.length === [...new Set(allTasks.map(task => task.department))].filter(dept => dept).length;
                if (allDeptsSelected) {
                     filteredTasks = [...allTasks];
                } else {
                    filteredTasks = allTasks.filter(task => selectedDepartments.includes(task.department));
                }
            }
            updateMultiSelectLabel();
            renderAllWeeks();
        }

        function showNextWeek() {
            const wrapper = document.getElementById('schedule-wrapper');
            wrapper.scrollBy({ left: wrapper.offsetWidth, behavior: 'smooth' });
        }

        function showPreviousWeek() {
            const wrapper = document.getElementById('schedule-wrapper');
            wrapper.scrollBy({ left: -wrapper.offsetWidth, behavior: 'smooth' });
        }

        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay() || 7; // Make Sunday 7
            if (day !== 1) d.setHours(-24 * (day - 1));
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function renderAllWeeks() {
            showRenderingStatus(true, 'Rendering schedule...');
            const container = document.getElementById('schedule-container');
            const wrapper = document.getElementById('schedule-wrapper');
            container.innerHTML = '';
            allWeekStartDates = [];

            if (filteredTasks.length === 0) {
                container.innerHTML = '<div class="loading">No tasks found for the selected department.</div>';
                return;
            }

            // Group tasks by the Monday of their week
            const tasksByWeek = {};
            let currentMonday = getMonday(new Date()); // Assign early for missing dates
            filteredTasks.forEach(task => {
                let taskDate = parseDate(task.date);
                if (!taskDate) {
                    task.missingDate = true;
                    taskDate = currentMonday; // Assign to current week for display
                }
                const monday = getMonday(taskDate);
                const mondayString = getLocalDateString(monday);
                if (!tasksByWeek[mondayString]) {
                    tasksByWeek[mondayString] = [];
                }
                tasksByWeek[mondayString].push(task);
            });

            // Generate all weeks between the earliest and latest non-empty weeks, including empty ones
            const mondayStrings = Object.keys(tasksByWeek);
            let allMondays = [];
            if (mondayStrings.length === 0) {
                // No tasks, include only current week
                currentMonday = getMonday(new Date());
                const currentMondayString = getLocalDateString(currentMonday);
                allMondays = [currentMonday];
                tasksByWeek[currentMondayString] = [];
            } else {
                mondayStrings.sort();
                const minMonday = new Date(mondayStrings[0] + 'T00:00:00');
                const maxMonday = new Date(mondayStrings[mondayStrings.length - 1] + 'T00:00:00');
                let current = new Date(minMonday);
                while (current <= maxMonday) {
                    const mondayString = getLocalDateString(current);
                    allMondays.push(new Date(current));
                    if (!tasksByWeek[mondayString]) {
                        tasksByWeek[mondayString] = [];
                    }
                    current.setDate(current.getDate() + 7);
                }
                // Include current week if not already included
                currentMonday = getMonday(new Date());
                const currentMondayString = getLocalDateString(currentMonday);
                if (!allMondays.some(d => d.getTime() === currentMonday.getTime())) {
                    allMondays.push(currentMonday);
                    allMondays.sort((a, b) => a - b);
                    if (!tasksByWeek[currentMondayString]) {
                        tasksByWeek[currentMondayString] = [];
                    }
                }
            }
            allWeekStartDates = allMondays;

            // --- Global Calculation for Row Normalization ---
            const maxTasksPerDept = {};
            DEPARTMENT_ORDER.forEach(dept => {
                const deptTasks = filteredTasks.filter(t => t.department === dept);
                if (deptTasks.length === 0) return;

                const tasksByDate = {};
                deptTasks.forEach(task => {
                    let taskDate = parseDate(task.date);
                    if (!taskDate) {
                        task.missingDate = true;
                        taskDate = getMonday(new Date());
                    }
                    const dateString = taskDate.toDateString();
                    if (!tasksByDate[dateString]) tasksByDate[dateString] = [];
                    tasksByDate[dateString].push(task);
                });

                const maxTasks = Math.max(0, ...Object.values(tasksByDate).map(tasks => tasks.length));
                if (maxTasks > 0) {
                    maxTasksPerDept[dept] = maxTasks;
                }
            });

            // Render a grid for each week using the global max tasks count
            allWeekStartDates.forEach(mondayDate => {
                container.appendChild(renderWeekGrid(mondayDate, maxTasksPerDept));
            });

            // Find the index of the current week to scroll to it
            currentMonday = getMonday(new Date());
            let initialWeekIndex = allWeekStartDates.findIndex(d => d.getTime() === currentMonday.getTime());
            if (initialWeekIndex === -1) { // If no tasks for current week, find the next future week
                initialWeekIndex = allWeekStartDates.findIndex(d => d > currentMonday);
                if (initialWeekIndex === -1) initialWeekIndex = allWeekStartDates.length - 1; // Default to last week
            }

            // Performance optimization: Use requestAnimationFrame for better performance
            requestAnimationFrame(() => {
                // Set the precise width for each grid now that they are in the DOM
                const wrapperWidth = wrapper.clientWidth;
                const grids = container.querySelectorAll('.schedule-grid');
                grids.forEach(grid => {
                    grid.style.width = `${wrapperWidth}px`;
                });

                // Scroll to the target grid
                if (grids[initialWeekIndex]) {
                    wrapper.scrollLeft = grids[initialWeekIndex].offsetLeft;
                }
                updateWeekDisplayHeader(allWeekStartDates[initialWeekIndex]);

                equalizeAllCardHeights();
            });

            // Hide rendering status after all operations complete
            setTimeout(() => showRenderingStatus(false), 100);
        }

        function updateWeekDisplayHeader(date) {
            if (!date) return;
            const monday = getMonday(date);
            const weekStart = new Date(monday);
            const weekEnd = new Date(monday);
            weekEnd.setDate(monday.getDate() + 5);
            const weekDisplay = document.getElementById('week-display');
            weekDisplay.textContent = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
        }

        function equalizeAllCardHeights() {
            const container = document.getElementById('schedule-container');
            const allRowClasses = new Set();

            // Performance optimization: Cache DOM queries and batch operations
            const grids = container.querySelectorAll('.schedule-grid');

            // Gather all unique row classes from all grids currently in the DOM
            grids.forEach(grid => {
                const classes = grid.dataset.rowClasses || '';
                classes.split(',').forEach(c => {
                    if (c) allRowClasses.add(c);
                });
            });

            allRowClasses.forEach(rowClass => {
                const elementsInRow = container.querySelectorAll(`.${rowClass}`);
                if (elementsInRow.length === 0) return;

                // Performance optimization: Batch DOM operations
                let maxHeight = 0;

                // First pass: find max height without modifying DOM
                elementsInRow.forEach(el => {
                    // Temporarily reset height to get natural size
                    const originalHeight = el.style.minHeight;
                    el.style.minHeight = 'auto';
                    const currentHeight = el.offsetHeight;
                    if (currentHeight > maxHeight) maxHeight = currentHeight;
                    // Restore original height immediately to avoid layout thrashing
                    el.style.minHeight = originalHeight;
                });

                // Second pass: apply the max height
                if (maxHeight > 0) {
                    elementsInRow.forEach(el => {
                        el.style.minHeight = `${maxHeight}px`;
                    });
                }
            });
        }

        function equalizeProjectCardHeights() {
            const projectSections = document.querySelectorAll('.project-dept-section');

            projectSections.forEach(section => {
                const cards = section.querySelectorAll('.project-task-card');
                if (cards.length === 0) return;

                // Find max height
                let maxHeight = 0;
                cards.forEach(card => {
                    const originalHeight = card.style.minHeight;
                    card.style.minHeight = 'auto';
                    const currentHeight = card.offsetHeight;
                    if (currentHeight > maxHeight) maxHeight = currentHeight;
                    card.style.minHeight = originalHeight;
                });

                // Apply max height to all cards in this section
                if (maxHeight > 0) {
                    cards.forEach(card => {
                        card.style.minHeight = `${maxHeight}px`;
                    });
                }
            });
        }

        function renderWeekGrid(dateForWeek, maxTasksPerDept) {
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';

            // --- Date Setup ---
            const monday = new Date(dateForWeek);
            monday.setDate(dateForWeek.getDate() - (dateForWeek.getDay() || 7) + 1);
            const weekDates = Array.from({ length: 6 }).map((_, i) => {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                return date;
            });

            // --- Header Row ---
            grid.innerHTML += `<div class="grid-header">Department</div>`;
            weekDates.forEach(date => {
                const isToday = date.toDateString() === new Date().toDateString();
                grid.innerHTML += `
                    <div class="grid-header">
                        <div class="date-container ${isToday ? 'today-highlight' : ''}">
                            <div class="date-weekday">${date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                            <div class="date-day">${date.toLocaleDateString('en-US', { day: 'numeric' })}</div>
                        </div>
                    </div>
                `;
            });

            // --- Data Grouping ---
            const tasksByDept = {};
            filteredTasks.forEach(task => {
                const dept = task.department || 'Other';
                if (!tasksByDept[dept]) tasksByDept[dept] = [];
                tasksByDept[dept].push(task);
            });

            const allRowClasses = new Set();

            // --- Render Department Rows ---
            DEPARTMENT_ORDER.forEach(dept => {
                if (tasksByDept[dept]) {
                    const deptTasks = tasksByDept[dept];
                    const tasksByDate = {};
                    weekDates.forEach(date => {
                        const dateString = date.toDateString();
                        tasksByDate[dateString] = deptTasks.filter(t => {
                            if (!t.date) return false;
                            const taskDate = parseDate(t.date);
                            return taskDate && taskDate.toDateString() === dateString;
                        });
                    });

                    const maxTasksInRow = maxTasksPerDept[dept] || 0;
                    if (maxTasksInRow === 0) return;

                    // Add department label, spanning all its potential rows
                    const deptLabel = document.createElement('div');
                    deptLabel.className = `department-label department-${normalizeDepartmentClass(dept)}`;
                    deptLabel.textContent = dept;
                    deptLabel.style.gridRow = `span ${maxTasksInRow}`;
                    grid.appendChild(deptLabel);

                    for (let i = 0; i < maxTasksInRow; i++) {
                        const rowClass = `dept-row-${normalizeDepartmentClass(dept)}-${i}`;
                        allRowClasses.add(rowClass);

                        weekDates.forEach(date => {
                            const dateString = date.toDateString();
                            const dayCell = document.createElement('div');
                            dayCell.className = 'grid-cell';
                            
                            const task = tasksByDate[dateString] ? tasksByDate[dateString][i] : undefined;

                            if (task) {
                                dayCell.innerHTML = `
                                    <div class="task-card ${rowClass} department-${normalizeDepartmentClass(task.department)}" data-task-id="${task.id}">
                                        <div class="task-title">${task.project}</div>
                                        <div class="task-day-counter">
                                           ${task.dayCounter || ''}
                                        </div>
                                        <div class="task-description">${task.description && task.description.trim() ? task.description : '<span class="missing-description">Staging Missing</span>'}</div>
                                          <div class="task-details">
                                              ${task.missingDate ? '<strong>Date:</strong> Missing<br>' : ''}
                                              <strong>Hours:</strong> ${task.hours}
                                          </div>
                                    </div>
                                `;
                            } else {
                                dayCell.innerHTML = `<div class="task-card-placeholder ${rowClass}"></div>`;
                            }
                            grid.appendChild(dayCell);
                        });
                    }
                }
            });

            grid.dataset.rowClasses = [...allRowClasses].join(',');
            return grid;
        }

        function showLoading(show) {
            const loadingElement = document.getElementById('loading');
            if (show) {
                loadingElement.style.display = 'block';
                // Performance monitoring: Track render start time
                window.renderStartTime = performance.now();
            } else {
                loadingElement.style.display = 'none';
                // Performance monitoring: Log render completion time
                if (window.renderStartTime) {
                    const renderTime = performance.now() - window.renderStartTime;
                    console.log(`Render completed in ${renderTime.toFixed(2)}ms`);
                    window.renderStartTime = null;
                }
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showRenderingStatus(show, message = 'Optimizing layout...') {
            const statusElement = document.getElementById('rendering-status');
            if (show) {
                statusElement.textContent = message;
                statusElement.style.display = 'block';
            } else {
                statusElement.style.display = 'none';
            }
        }

        // Event listeners
        const dropdown = document.getElementById('multi-select-dropdown');
        const dropdownBtn = document.getElementById('multi-select-btn');
        const dropdownPanel = document.getElementById('multi-select-panel');

        dropdownBtn.addEventListener('click', () => {
            const isOpen = dropdown.classList.toggle('open');
            dropdownBtn.setAttribute('aria-expanded', isOpen);
        });

        document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
                dropdownBtn.setAttribute('aria-expanded', 'false');
            }
        });

        document.getElementById('select-all-btn').addEventListener('click', () => {
            document.querySelectorAll('#department-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            filterTasks();
        });

        document.getElementById('select-none-btn').addEventListener('click', () => {
            document.querySelectorAll('#department-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            filterTasks();
        });

        document.getElementById('refresh-btn').addEventListener('click', fetchTasks);
        document.getElementById('prev-week-btn').addEventListener('click', showPreviousWeek);
        document.getElementById('next-week-btn').addEventListener('click', showNextWeek);

        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const expandIcon = document.getElementById('fullscreen-icon-expand');
        const compressIcon = document.getElementById('fullscreen-icon-compress');

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function updateFullscreenIcon() {
            if (document.fullscreenElement) {
                expandIcon.style.display = 'none';
                compressIcon.style.display = 'block';
            } else {
                expandIcon.style.display = 'block';
                compressIcon.style.display = 'none';
            }
        }

        fullscreenBtn.addEventListener('click', toggleFullscreen);
        document.addEventListener('fullscreenchange', updateFullscreenIcon);

        document.getElementById('schedule-wrapper').addEventListener('scrollend', () => {
            const wrapper = document.getElementById('schedule-wrapper');
            const currentIndex = Math.round(wrapper.scrollLeft / wrapper.offsetWidth);
            const currentWeekDate = allWeekStartDates[currentIndex];
            updateWeekDisplayHeader(currentWeekDate);
        });

        // Context Menu Functionality
        let currentTask = null;

        document.addEventListener('click', (e) => {
            const taskCard = e.target.closest('.task-card');
            if (taskCard) {
                // Don't show context menu if inside the build plan modal
                if (document.getElementById('project-modal').classList.contains('show')) {
                    return;
                }
                e.preventDefault();
                currentTask = taskCard.dataset.taskId ? allTasks.find(t => t.id === taskCard.dataset.taskId) : null;
                if (currentTask) {
                    showContextMenu(e.clientX, e.clientY);
                }
                return; // Prevent the hide handler from running
            }

            // Hide menu if click is outside task card and outside menu
            const contextMenu = document.getElementById('context-menu');
            if (!contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
            }
        });

        document.getElementById('context-menu').addEventListener('click', (e) => {
            const action = e.target.closest('.context-menu-item')?.dataset.action;
            if (action === 'build-plan' && currentTask) {
                showProjectView(currentTask.project);
            }
            document.getElementById('context-menu').style.display = 'none';
        });

        function showContextMenu(x, y) {
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
            contextMenu.style.display = 'block';

            // Adjust position if menu goes outside viewport
            const rect = contextMenu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                contextMenu.style.left = `${x - rect.width}px`;
            }
            if (rect.bottom > window.innerHeight) {
                contextMenu.style.top = `${y - rect.height}px`;
            }
        }

        // Project View Functionality
        function showProjectView(projectName) {
            currentProjectName = projectName;
            const projectTasks = allTasks.filter(task => task.project === projectName);

            const modal = document.getElementById('project-modal');
            const title = document.getElementById('project-title');
            const grid = document.getElementById('project-schedule-grid');

            title.textContent = `Build Plan: ${projectName}`;
            grid.innerHTML = '';

            // Group tasks by department
            const tasksByDept = {};
            projectTasks.forEach(task => {
                const dept = task.department || 'Other';
                if (!tasksByDept[dept]) tasksByDept[dept] = [];
                tasksByDept[dept].push(task);
            });

            // Sort departments in the same order as main view
            const sortedDepts = DEPARTMENT_ORDER.filter(dept => tasksByDept[dept]);
            if (tasksByDept['Other']) sortedDepts.push('Other');

            // Create a simple list layout instead of complex grid
            sortedDepts.forEach(dept => {
                const deptTasks = tasksByDept[dept].sort((a, b) => {
                    // Sort by date, then by day number
                    const dateA = parseDate(a.date);
                    const dateB = parseDate(b.date);
                    if (dateA && dateB) {
                        const dateDiff = dateA - dateB;
                        if (dateDiff !== 0) return dateDiff;
                    }
                    return parseInt(a.dayNumber || 0) - parseInt(b.dayNumber || 0);
                });

                // Add department section
                const deptSection = document.createElement('div');
                deptSection.className = 'project-dept-section';
                deptSection.innerHTML = `
                    <div class="project-dept-header department-label department-${normalizeDepartmentClass(dept)}">
                        ${dept}
                    </div>
                    <div class="project-cards-container">
                        ${deptTasks.map((task, index) => {
                            const taskDate = parseDate(task.date);
                            const formattedDate = task.missingDate ? 'No date' : (taskDate ? taskDate.toLocaleDateString('en-US', {
                                weekday: 'short',
                                month: 'short',
                                day: 'numeric',
                                year: 'numeric'
                            }) : 'No date');

                            return `
                                <div class="project-task-card task-card department-${normalizeDepartmentClass(task.department)}" style="animation-delay: ${index * 0.1}s" data-task-id="${task.id}">
                                    <div class="task-title">${task.project}</div>
                                    <div class="task-day-counter">${task.dayCounter || ''}</div>
                                    <div class="task-description">${task.description && task.description.trim() ? task.description : '<span class="missing-description">Staging Missing</span>'}</div>
                                    <div class="task-details">
                                        <strong>Date:</strong> ${formattedDate}<br>
                                        <strong>Hours:</strong> ${task.hours}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                grid.appendChild(deptSection);
            });

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            // Equalize card heights in project view after a short delay
            setTimeout(() => {
                equalizeProjectCardHeights();
            }, 100);

            // Initialize edit mode
            initializeEditMode();
        }

        function hideProjectView() {
            // Cancel edit mode if active when exiting
            const textareas = document.querySelectorAll('#project-schedule-grid .edit-description');
            if (textareas.length > 0) {
                textareas.forEach(textarea => {
                    const taskCard = textarea.closest('.project-task-card');
                    const taskId = taskCard.dataset.taskId;
                    const task = allTasks.find(t => t.id === taskId);
                    const descDiv = document.createElement('div');
                    descDiv.className = 'task-description';
                    descDiv.innerHTML = task && task.description ? task.description : '<span class="missing-description">Staging Missing</span>';
                    textarea.replaceWith(descDiv);
                });
                // Reset buttons to non-edit state
                document.getElementById('edit-plan-btn').style.display = 'inline-block';
                document.getElementById('save-changes-btn').style.display = 'none';
                document.getElementById('cancel-changes-btn').style.display = 'none';
            }

            const modal = document.getElementById('project-modal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        document.getElementById('project-close').addEventListener('click', hideProjectView);
        document.getElementById('project-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('project-modal')) {
                hideProjectView();
            }
        });

        function initializeEditMode() {
            const unlockBtn = document.getElementById('unlock-editing-btn');
            const editBtn = document.getElementById('edit-plan-btn');
            const saveBtn = document.getElementById('save-changes-btn');
            const cancelBtn = document.getElementById('cancel-changes-btn');
            let originalDescriptions = new Map();
            let isEditingUnlocked = localStorage.getItem('editingUnlocked') === 'true';

            // Check unlock status and update UI
            if (isEditingUnlocked) {
                unlockBtn.style.display = 'none';
                editBtn.style.display = 'inline-block';
            }

            unlockBtn.addEventListener('click', () => {
                const password = prompt('Enter password to unlock editing:');
                if (password === EDIT_PASSWORD) {
                    isEditingUnlocked = true;
                    localStorage.setItem('editingUnlocked', 'true');
                    unlockBtn.style.display = 'none';
                    editBtn.style.display = 'inline-block';
                } else {
                    alert('Incorrect password. Editing remains locked.');
                }
            });

            editBtn.addEventListener('click', () => {
                if (!isEditingUnlocked) return;
                enterEditMode();
            });

            saveBtn.addEventListener('click', async () => {
                await saveChanges();
            });

            cancelBtn.addEventListener('click', () => {
                cancelEditMode();
            });

            function enterEditMode() {
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'inline-block';

                const descriptions = document.querySelectorAll('#project-schedule-grid .task-description');
                descriptions.forEach(desc => {
                    const taskId = desc.closest('.project-task-card').dataset.taskId;
                    const originalText = desc.innerHTML;
                    originalDescriptions.set(taskId, originalText);

                    const textarea = document.createElement('textarea');
                    textarea.className = 'edit-description';
                    textarea.value = desc.textContent.trim() === 'Staging Missing' ? '' : desc.textContent.trim();
                    desc.replaceWith(textarea);
                });
            }

            async function saveChanges() {
                // Set loading state
                saveBtn.disabled = true;
                cancelBtn.disabled = true;
                saveBtn.innerHTML = '<div class="save-loading-spinner"></div>Saving...';
                saveBtn.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
                saveBtn.style.cursor = 'not-allowed';

                // Show loading overlay
                const overlay = document.getElementById('project-loading-overlay');
                overlay.style.display = 'flex';

                try {
                    const textareas = document.querySelectorAll('#project-schedule-grid .edit-description');
                    const changedTasks = [];
                    textareas.forEach(textarea => {
                        const taskId = textarea.closest('.project-task-card').dataset.taskId;
                        const originalText = originalDescriptions.get(taskId);
                        const originalStripped = stripHtml(originalText).trim();
                        const newText = textarea.value.trim();

                        // Update the task
                        const task = allTasks.find(t => t.id === taskId);
                        if (task) {
                            task.description = newText;
                        }

                        // Replace textarea
                        const descDiv = document.createElement('div');
                        descDiv.className = 'task-description';
                        descDiv.innerHTML = newText || '<span class="missing-description">Staging Missing</span>';
                        textarea.replaceWith(descDiv);

                        // Check if changed
                        if (newText !== originalStripped) {
                            changedTasks.push({task, newText});
                        }
                    });

                    // Save to staging if there are changes
                    if (changedTasks.length > 0) {
                        await saveToStaging(currentProjectName, changedTasks);

                        // Show success notification
                        const successNotif = document.getElementById('project-success-notification');
                        successNotif.style.display = 'block';
                        setTimeout(() => {
                            successNotif.style.display = 'none';
                        }, 2500);
                    }

                    exitEditMode();
                } catch (error) {
                    console.error('Save failed:', error);
                    // Show error feedback
                    saveBtn.innerHTML = '❌ Save Failed';
                    saveBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    setTimeout(() => {
                        restoreSaveButton();
                    }, 2000);
                } finally {
                    // Hide loading overlay
                    overlay.style.display = 'none';
                    if (!saveBtn.innerHTML.includes('Failed')) {
                        restoreSaveButton();
                    }
                }
            }

            function restoreSaveButton() {
                saveBtn.disabled = false;
                cancelBtn.disabled = false;
                saveBtn.innerHTML = '💾 Save Changes';
                saveBtn.style.background = 'linear-gradient(135deg, #4ade80 0%, #22c55e 100%)';
                saveBtn.style.cursor = 'pointer';
            }

            function cancelEditMode() {
                const textareas = document.querySelectorAll('#project-schedule-grid .edit-description');
                textareas.forEach(textarea => {
                    const taskId = textarea.closest('.project-task-card').dataset.taskId;
                    const originalText = originalDescriptions.get(taskId);

                    const descDiv = document.createElement('div');
                    descDiv.className = 'task-description';
                    descDiv.innerHTML = originalText;
                    textarea.replaceWith(descDiv);
                });

                exitEditMode();
            }

            function exitEditMode() {
                editBtn.style.display = 'inline-block';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                originalDescriptions.clear();
            }
        }


        // Auto-refresh every 30 minutes (reduce frequency to improve performance)
        setInterval(fetchTasks, 30 * 60 * 1000);

        // Initial load
        fetchTasks();
    </script>
</body>
</html>
